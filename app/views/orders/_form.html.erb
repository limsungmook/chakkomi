<%= form_for(@order) do |f| %>
  <% if @order.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@order.errors.count, "error") %> prohibited this order from being saved:</h2>

      <ul>
      <% @order.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= f.label "주문자 이름" %><br />
    <%= text_field_tag :name, current_user.name  %>
  </div>
  <div class="field">
    <%= f.label "예금주" %><br />
    <%= text_field_tag :account_owner, current_user.name %>
  </div>
  <div class="field">
    <%= f.label "연락 가능 번호" %><br />
    <%= f.text_field :phone %>
  </div>

  우편번호 검색<br />
  <input id="dong_name" type="search"/>
  <input type="button" class="zipcode-search button write small" value="우편번호 검색"/>  
  <div class="zipcode_search_result">

  </div>
  <div class="field">
    <%= f.label :address %><br />
    <%= text_field_tag :address1 ,current_user.delivery_address1, :size => 50 %><br />
  상세 주소 입력<br />
     <%= text_field_tag :address2, current_user.delivery_address2 %>
  </div>
  <div class="field">
    <%= f.label :email %><br />
    <%= f.email_field :email, :size => 40 %>
  </div>
  <div class="field">
    <%= f.label :pay_type %><br />
    <%= f.select :pay_type, Order::PAYMENT_TYPES, :prompt => '지불 형태를 고르세요' %>
  </div>
  <div class="field">
    <%= f.label :arrival_payment %><br />
    <%= f.select :arrival_payment, Order::ARRIVAL_PAYMENT, :prompt => '선불? 착불?'  %>
  </div>
  <div id="total_price">
    총액: <span id="total_price"><%= number_with_delimiter(@cart.total_price) %></span>원
  <%= hidden_field_tag :total_price ,@cart.total_price %>
  </div>
  <div class="actions">
    
    <%= f.submit '주문하기'%>
  </div>
<% end %>


<script type="text/javascript">
$(function(){

	var xml_addressdata = ''
	var html_render = ''
	var current_end = 0

	$('#order_arrival_payment').change(function() {
		if($("#order_arrival_payment").val() == '선불')
		{
		    $('#total_price').html('<span id=span_total_price>총액:  <%= number_with_delimiter(@cart.total_price + Order::DELIVERY_COST) %> 원</span><%= hidden_field_tag :total_price, @cart.total_price + Order::DELIVERY_COST %>' );
		}else
		{
		    $('#total_price').html('<span id=span_total_price>총액:  <%= number_with_delimiter(@cart.total_price) %> 원</span><%= hidden_field_tag :total_price, @cart.total_price %>' );
		}
	    });
	var address = {
	back_page: function(){
		address.present_posts(xml_addressdata, current_end - 20, current_end - 10);
		current_end -= 10;
	    },
	next_page: function(){
		address.present_posts(xml_addressdata, current_end, current_end + 10);
		current_end += 10;
	    },
	present_posts: function(addressdata, start, end) {
		var present_addressdata = ''
		var current_item = ''
		if(start < 0)
		{
		    start = 0;
		    end = 10;
		}
		for( i = start; i < end; i++)
		{
		    current_item =  $(addressdata).find("item").eq(i);
		    if( current_item.length == 0)
		    {
			end = -1;
			break;
		    }
		    present_addressdata = present_addressdata +
 							 '<a href=# class=postaddress_link><span class=parsed_address>(' + 
							 $(current_item).find("postcd").text().substr(0,3)  + 
							 '-' + 
							 $(current_item).find("postcd").text().substr(3,5) + 
							 ')' + 
							 $(current_item).find("address").text() + 
							 '</span></a><br />'
		}
		if(start != 0)
		{
		    present_addressdata = present_addressdata + '<a href=# class=back_page>이전'
		}
		if(end != -1)
		{
		    if($(addressdata).find("item").eq(end + 1).length > 0)
		    {
			present_addressdata = present_addressdata + '<a href=# class=next_page>다음'
		    }
		}
		$('.zipcode_search_result').html(present_addressdata);
		address.bindPutAddress();
	    },
	do_submit: function(){
		xml_addressdata = ''
		html_render = ''
		current_end = 0

		$('.zipcode_search_result').text("로딩중");
		$.get('<%= url_for :action => 'zipsearch' %>', {
		    query: $('#dong_name').val() 
			    }, function(xml){
			
			                        xml_addressdata = xml;
                         			address.next_page();
			    }, 'xml');
	    },
	bindZipcodeFind: function(){
		$('#dong_name').keydown(address.keypressed);
		$('.zipcode-search').click(address.do_submit);
	    },
	submit_search: function( event ){
		var values = new Array;
		event.preventDefault;
		values[0] = $('#dong_name').attr('value');
		if (values[0]) {
		    address.do_submit('#address1',values);
		} else {
		    alert ('No Item given');
		}
		return false;
	    },
	keypressed: function(){
		var charcode = (event.which) ? event.which : window.event.keyCode ;
		if ( charcode == 13 ) {
		    return address.submit_search( event );
		}
		return true;
	    },
	bindPutAddress: function(){
		$('.next_page').click(function(){
			address.next_page();
		    });
		$('.back_page').click(function(){
			address.back_page();
		    });
		$('.zipcode_search_result .postaddress_link').click(function(){
			$('#address1').val($(this).children('.parsed_address').text());
			address.hideZipcodeFinder();
			$('[name=addr]').focus();
			return false;
		    });
	    },
	remove_useless_addr: function(address){
		if(address.indexOf('~') != -1){
		    address = address.split(' ').slice(0, -1).join(' ');
		}
		return address;
	    },
	hideZipcodeFinder: function(){
		$('.zipcode_search_result').slideUp();
	    }
	}
	address.bindZipcodeFind();
    });

</script>
    
